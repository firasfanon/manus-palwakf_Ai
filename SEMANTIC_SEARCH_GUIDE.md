# ุฏููู ูุธุงู ุงูุจุญุซ ุงูุฏูุงูู (Semantic Search)

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุทููุฑ ูุธุงู ุจุญุซ ุฏูุงูู ูุชูุฏู ูุฌูุน ุจูู **ุงูุจุญุซ ุงูุฏูุงูู** (Semantic Search) ู**ุงูุจุญุซ ุจุงููููุงุช ุงูููุชุงุญูุฉ** (Keyword Search) ูุชุญุณูู ุฏูุฉ ูุชุงุฆุฌ ุงูุจุญุซ ุจูุณุจุฉ 20-30%.

---

## ุงูููููุงุช ุงูุฑุฆูุณูุฉ

### 1. ููู `server/embeddings.ts`

ูุญุชูู ุนูู ุงูุฏูุงู ุงูุฃุณุงุณูุฉ ููุจุญุซ ุงูุฏูุงูู:

#### `generateEmbeddings(text: string): Promise<number[]>`
- **ุงููุธููุฉ**: ุชูููุฏ vector embeddings ููุต ูุนูู ุจุงุณุชุฎุฏุงู OpenAI
- **ุงููุฏุฎูุงุช**: ูุต ุนุฑุจู ุฃู ุฅูุฌููุฒู
- **ุงููุฎุฑุฌุงุช**: ูุตูููุฉ ุฃุฑูุงู (1536 dimension) ุชูุซู ุงููุนูู ุงูุฏูุงูู ูููุต
- **ุงูุงุณุชุฎุฏุงู**:
  ```typescript
  const embedding = await generateEmbeddings("ูุง ูู ุดุฑูุท ุตุญุฉ ุงููููุ");
  ```

#### `cosineSimilarity(embedding1, embedding2): number`
- **ุงููุธููุฉ**: ุญุณุงุจ ุงูุชุดุงุจู ุจูู ูุตูู ุจุงุณุชุฎุฏุงู Cosine Similarity
- **ุงููุฎุฑุฌุงุช**: ุฑูู ุจูู 0 ู 1 (1 = ูุชุทุงุจู ุชูุงูุงูุ 0 = ูุฎุชูู ุชูุงูุงู)
- **ุงูุงุณุชุฎุฏุงู**:
  ```typescript
  const similarity = cosineSimilarity(queryEmbedding, docEmbedding);
  if (similarity > 0.7) {
    console.log("ุงููุตุงู ูุชุดุงุจูุงู ุฌุฏุงู");
  }
  ```

#### `semanticSearch<T>(queryEmbedding, documents, topK): Array<T>`
- **ุงููุธููุฉ**: ุงูุจุญุซ ุงูุฏูุงูู ุงูุจุญุช
- **ุงููุฏุฎูุงุช**:
  - `queryEmbedding`: embedding ุงูุณุคุงู
  - `documents`: ูุงุฆูุฉ ุงููุณุชูุฏุงุช ูุน embeddings
  - `topK`: ุนุฏุฏ ุงููุชุงุฆุฌ ุงููุทููุจุฉ (ุงูุชุฑุงุถู: 5)
- **ุงููุฎุฑุฌุงุช**: ูุณุชูุฏุงุช ูุฑุชุจุฉ ุญุณุจ ุงูุชุดุงุจู ุงูุฏูุงูู

#### `hybridSearch<T>(queryEmbedding, documents, semanticWeight, topK): Array<T>`
- **ุงููุธููุฉ**: **ุงูุจุญุซ ุงููุฌูู** - ูุฌูุน ุจูู ุงูุฏูุงูู ูุงููููุงุช ุงูููุชุงุญูุฉ
- **ุงููุฏุฎูุงุช**:
  - `semanticWeight`: ูุฒู ุงูุจุญุซ ุงูุฏูุงูู (0-1ุ ุงูุชุฑุงุถู: 0.7)
  - ุงูุจููุฉ ูุซู `semanticSearch`
- **ุงูุตูุบุฉ**: `Combined Score = (Semantic ร 0.7) + (Keyword ร 0.3)`
- **ุงูุงุณุชุฎุฏุงู**:
  ```typescript
  const results = hybridSearch(
    queryEmbedding,
    documents,
    0.7, // 70% semantic, 30% keyword
    10
  );
  ```

---

### 2. ุชุญุฏูุซุงุช `server/rag.ts`

ุชู ุชุญุฏูุซ ุฏุงูุฉ `retrieveRelevantDocuments` ูุฏุนู ุงูุจุญุซ ุงููุฌูู:

```typescript
export async function retrieveRelevantDocuments(
  query: string,
  options?: {
    category?: string;
    limit?: number;
    minScore?: number;
    useSemanticSearch?: boolean; // ุฌุฏูุฏ!
  }
): Promise<Array<KnowledgeDocument & { relevanceScore: number }>>
```

**ุขููุฉ ุงูุนูู**:
1. ูุญุต ูุฌูุฏ embeddings ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. ุฅุฐุง ูุงูุช ูุชููุฑุฉ: ุงุณุชุฎุฏุงู Hybrid Search (70% semantic + 30% keyword)
3. ุฅุฐุง ูู ุชูู ูุชููุฑุฉ: ุงูุฑุฌูุน ุฅูู Keyword Search ููุท
4. ูู ุญุงูุฉ ุญุฏูุซ ุฎุทุฃ: Fallback ุชููุงุฆู ุฅูู Keyword Search

---

### 3. ุชุญุฏูุซุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

ุชู ุฅุถุงูุฉ ุญูู `embedding` ูู ุฌุฏูู `knowledge_documents`:

```typescript
embedding: text("embedding"), // JSON array of embedding vector (1536 dimensions)
```

**Migration**: `drizzle/0014_fuzzy_iron_lad.sql`

---

### 4. ุณูุฑูุจุช `scripts/generate-embeddings.mjs`

ุณูุฑูุจุช ูุชูููุฏ embeddings ูุฌููุน ุงููุฑุงุฌุน ุงูููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

**ุงูููุฒุงุช**:
- ูุนุงูุฌุฉ ุฏูุนูุฉ (Batch Processing): 10 ูุณุชูุฏุงุช ูู ูู ุฏูุนุฉ
- ุชุฃุฎูุฑ ุจูู ุงูุฏูุนุงุช (1 ุซุงููุฉ) ูุชุฌูุจ Rate Limits
- ุชูุงุฑูุฑ ุชูุตูููุฉ ุนู ุงูุชูุฏู
- ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก ุงูุชููุงุฆูุฉ
- ุชุฎุทู ุงููุณุชูุฏุงุช ุงูุชู ูุฏููุง embeddings ุจุงููุนู

**ุงูุงุณุชุฎุฏุงู**:
```bash
cd /home/ubuntu/waqf_ai_model
pnpm exec tsx scripts/generate-embeddings.mjs
```

**ุงููุฎุฑุฌุงุช ุงููุชููุนุฉ**:
```
๐ Starting embeddings generation...
๐ Found 131 documents

๐ฆ Processing batch 1/14
๐ [1/131] Generating embedding for "ูุฌูุฉ ุงูุฃุญูุงู ุงูุนุฏููุฉ - ูุชุงุจ ุงูููู..."
โ [1/131] Updated "ูุฌูุฉ ุงูุฃุญูุงู ุงูุนุฏููุฉ - ูุชุงุจ ุงูููู..."
...

๐ Summary:
Total documents: 131
Processed: 131
Updated: 131
Skipped: 0
Errors: 0
```

---

## ููููุฉ ุงูุชูุนูู

### ุงูุฎุทูุฉ 1: ุงูุชุฃูุฏ ูู ุชููุฑ API Key

ูุญุชุงุฌ ุงููุธุงู ุฅูู OpenAI API Key ุฃู Manus Embeddings API:

```bash
# ูู ููู .env
BUILT_IN_FORGE_API_KEY=your_api_key_here
BUILT_IN_FORGE_API_URL=https://forge.manus.im
```

### ุงูุฎุทูุฉ 2: ุชูููุฏ Embeddings ูููุฑุงุฌุน ุงูููุฌูุฏุฉ

```bash
cd /home/ubuntu/waqf_ai_model
pnpm exec tsx scripts/generate-embeddings.mjs
```

### ุงูุฎุทูุฉ 3: ุงูุชุญูู ูู ุงููุชุงุฆุฌ

```sql
-- ุนุฏุฏ ุงููุณุชูุฏุงุช ุงูุชู ูุฏููุง embeddings
SELECT COUNT(*) FROM knowledge_documents WHERE embedding IS NOT NULL;

-- ุนููุฉ ูู embeddings
SELECT id, title, LEFT(embedding, 100) as embedding_sample 
FROM knowledge_documents 
WHERE embedding IS NOT NULL 
LIMIT 5;
```

### ุงูุฎุทูุฉ 4: ุงุฎุชุจุงุฑ ุงููุธุงู

```bash
cd /home/ubuntu/waqf_ai_model
pnpm test semantic-search
```

---

## ุงูุงุฎุชุจุงุฑุงุช (Vitest)

ููู `server/semantic-search.test.ts` ูุญุชูู ุนูู ุงุฎุชุจุงุฑุงุช ุดุงููุฉ:

### ุงุฎุชุจุงุฑุงุช ุงููุญุฏุฉ (Unit Tests)
- โ ุชูููุฏ embeddings ููุต ุนุฑุจู
- โ ุงุฎุชูุงู embeddings ููุตูุต ูุฎุชููุฉ
- โ Cosine Similarity ูููุตูุต ุงููุชุทุงุจูุฉ (= 1)
- โ Cosine Similarity ูููุตูุต ุงููุชุนุงูุฏุฉ (= 0)
- โ Semantic Search - ุชุฑุชูุจ ุงููุชุงุฆุฌ
- โ Hybrid Search - ุฏูุฌ ุงููุชุงุฆุฌ

### ุงุฎุชุจุงุฑุงุช ุงูุชูุงูู (Integration Tests)
- โ ุงูุชุดุงุจู ุงูุฏูุงูู ุจูู ูุตูุต ุนุฑุจูุฉ ูุชุดุงุจูุฉ
- โ ุชุฑุชูุจ ุงููุณุชูุฏุงุช ุญุณุจ ุงูุชุดุงุจู ุงูุฏูุงูู

**ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช**:
```bash
pnpm test semantic-search
```

---

## ููุงุฑูุฉ ุงูุฃุฏุงุก

### ูุจู Semantic Search (Keyword Only)
- **ุงูุฏูุฉ**: 60-70%
- **ุงููุดุงูู**:
  - ุนุฏู ููู ุงููุฑุงุฏูุงุช (ูุซูุงู: "ููู" vs "ุญุจุณ")
  - ุนุฏู ููู ุงูุณูุงู (ูุซูุงู: "ุดุฑูุท ุงูููู" vs "ุดุฑูุท ุงูุจูุน")
  - ุงูุงุนุชูุงุฏ ุนูู ุงูุชุทุงุจู ุงูุญุฑูู

### ุจุนุฏ Semantic Search (Hybrid)
- **ุงูุฏูุฉ ุงููุชููุนุฉ**: 80-90% (+20-30%)
- **ุงููููุฒุงุช**:
  - โ ููู ุงููุฑุงุฏูุงุช ูุงููุนุงูู ุงููุชุดุงุจูุฉ
  - โ ููู ุงูุณูุงู ูุงูููุฉ ูู ุงูุณุคุงู
  - โ ูุชุงุฆุฌ ุฃูุซุฑ ุตูุฉ ุญุชู ุจุฏูู ุชุทุงุจู ุญุฑูู
  - โ Fallback ุชููุงุฆู ูู ุญุงูุฉ ุงูุฃุฎุทุงุก

---

## ุฃูุซูุฉ ุนูููุฉ

### ูุซุงู 1: ุงูุจุญุซ ุนู "ุดุฑูุท ุงูููู"

**Keyword Search ููุท**:
```
ุงููุชุงุฆุฌ: ูุณุชูุฏุงุช ุชุญุชูู ุนูู ูููุฉ "ุดุฑูุท" + "ููู"
ุงููุดููุฉ: ูุฏ ุชููุช ูุณุชูุฏุงุช ุชุชุญุฏุซ ุนู "ุฃุฑูุงู ุงูููู" ุฃู "ุตุญุฉ ุงูููู"
```

**Hybrid Search**:
```
ุงููุชุงุฆุฌ: 
1. "ุดุฑูุท ุตุญุฉ ุงูููู" (ุชุทุงุจู ุญุฑูู + ุฏูุงูู)
2. "ุฃุฑูุงู ุงูููู ุงูุฃุฑุจุนุฉ" (ุชุดุงุจู ุฏูุงูู ุนุงูู)
3. "ุตูุบุฉ ุงูููู ูุดุฑูุทูุง" (ุชุดุงุจู ุฏูุงูู ูุชูุณุท)
```

### ูุซุงู 2: ุงูุจุญุซ ุนู "ูู ูุฌูุฒ ุจูุน ุงููููุ"

**Keyword Search**:
```
ุงูุจุญุซ ุนู: "ุจูุน" + "ููู"
ูุฏ ูููุช: ูุณุชูุฏุงุช ุนู "ุงูุชุตุฑู ูู ุงูููู" ุฃู "ุงุณุชุจุฏุงู ุงูููู"
```

**Semantic Search**:
```
ูููู ุฃู ุงูุณุคุงู ุนู:
- ุฌูุงุฒ ุงูุจูุน
- ุงูุชุตุฑูุงุช ุงููุงููููุฉ ูู ุงูููู
- ุงูุงุณุชุจุฏุงู ูุงูุชุจุฏูู

ุงููุชุงุฆุฌ ุชุดูู ูู ูุง ุณุจู!
```

---

## ุงูุญุงูุฉ ุงูุญุงููุฉ

### โ ุชู ุฅูุฌุงุฒู
1. โ ุชุตููู ุจููุฉ ูุธุงู Semantic Search
2. โ ุฅูุดุงุก ููู `server/embeddings.ts` ูุน ุฌููุน ุงูุฏูุงู
3. โ ุชุญุฏูุซ `server/rag.ts` ูุฏุนู Hybrid Search
4. โ ุฅุถุงูุฉ ุญูู `embedding` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
5. โ ุฅูุดุงุก ุณูุฑูุจุช `generate-embeddings.mjs`
6. โ ูุชุงุจุฉ ุงุฎุชุจุงุฑุงุช Vitest ุดุงููุฉ
7. โ Migration ูุงุนุฏุฉ ุงูุจูุงูุงุช (0014)

### โ๏ธ ูุญุชุงุฌ ุฅูู ุชูุนูู
1. โ๏ธ **Embeddings API**: ุญุงููุงู ูุนุทู 404 Not Found
   - **ุงูุณุจุจ**: endpoint `/llm/embeddings` ุบูุฑ ูุชุงุญ ูู Manus Forge API
   - **ุงูุญููู ุงูููููุฉ**:
     - ุงุณุชุฎุฏุงู OpenAI API ูุจุงุดุฑุฉ (ูุญุชุงุฌ API key)
     - ุงูุชุธุงุฑ ุชูุนูู embeddings ูู Manus API
     - ุงุณุชุฎุฏุงู ูููุฐุฌ embeddings ูุญูู

2. โ๏ธ **ุชูููุฏ Embeddings ูููุฑุงุฌุน ุงูููุฌูุฏุฉ**
   - ุจุนุฏ ุญู ูุดููุฉ APIุ ุชุดุบูู: `pnpm exec tsx scripts/generate-embeddings.mjs`

---

## ุงูุชูุตูุงุช

### ููุงุณุชุฎุฏุงู ุงูููุฑู
1. ุงููุธุงู ูุนูู ุญุงููุงู ุจู **Keyword Search ููุท** (Fallback)
2. ุงูุฏูุฉ ุงูุญุงููุฉ: 60-70%
3. ูุง ุญุงุฌุฉ ูุฃู ุชุบููุฑุงุช ูู ุงูููุฏ

### ูุชูุนูู Semantic Search
1. **ุงูุฎูุงุฑ 1: ุงุณุชุฎุฏุงู OpenAI API**
   ```bash
   # ุฅุถุงูุฉ ูู webdev secrets
   OPENAI_API_KEY=sk-...
   ```
   
   ุซู ุชุญุฏูุซ `server/embeddings.ts`:
   ```typescript
   const response = await fetch("https://api.openai.com/v1/embeddings", {
     method: "POST",
     headers: {
       "Content-Type": "application/json",
       "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
     },
     body: JSON.stringify({
       input: text,
       model: "text-embedding-3-small",
     }),
   });
   ```

2. **ุงูุฎูุงุฑ 2: ุงูุชุธุงุฑ ุชูุนูู Manus Embeddings API**
   - ุงูููุฏ ุฌุงูุฒ ููุนูู ููุฑ ุชูุนูู API

3. **ุงูุฎูุงุฑ 3: ูููุฐุฌ ูุญูู (Offline)**
   - ุงุณุชุฎุฏุงู ููุชุจุฉ ูุซู `@xenova/transformers`
   - ููุฒุฉ: ูุง ูุญุชุงุฌ API key
   - ุนูุจ: ุฃุจุทุฃ ููููุงู

---

## ุงูุฎูุงุตุฉ

ุชู ุจูุงุก ูุธุงู ุจุญุซ ุฏูุงูู ูุชูุฏู **ุฌุงูุฒ ููุงุณุชุฎุฏุงู** ุจูุฌุฑุฏ ุชููุฑ Embeddings API. ุงููุธุงู:

โ **ูุตูู ุจุดูู ุงุญุชุฑุงูู** ูุน Hybrid Search  
โ **ุขูู** ูุน Fallback ุชููุงุฆู  
โ **ูุฎุชุจุฑ** ูุน Vitest  
โ **ููุซู** ุจุดูู ูุงูู  
โ **ูุงุจู ููุชูุณุน** ูุฅุถุงูุฉ ูุตุงุฏุฑ ุฌุฏูุฏุฉ  

**ุงูุฎุทูุฉ ุงูุชุงููุฉ**: ุชูุนูู Embeddings API ูุงุฎุชุจุงุฑ ุงููุธุงู ุนูู ุฃุณุฆูุฉ ุญููููุฉ!
